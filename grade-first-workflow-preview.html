<!doctype html>
<html lang="ko">
<head>
      <meta charset="UTF-8" />
      <meta
        http-equiv="Cache-Control"
        content="no-store, no-cache, must-revalidate, max-age=0"
      />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>성취기준 우선 수업스케치 워크플로우</title>
    <style>
      :root {
        color-scheme: light;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Inter, Pretendard, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 24px;
        background: #f4f7fb;
      }
      h1,
      h2,
      h3 {
        margin: 0;
      }
      h1 {
        margin-bottom: 6px;
      }
      p {
        margin: 0;
      }
      .subtitle {
        color: #475569;
        margin-bottom: 16px;
      }
      .layout {
        display: grid;
        gap: 16px;
        grid-template-columns: 340px 1fr;
        align-items: start;
      }
      .card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 14px;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.05);
      }
      .row {
        margin-bottom: 12px;
      }
      label {
        display: block;
        font-size: 13px;
        color: #475569;
        margin-bottom: 4px;
      }
      select,
      button {
        width: 100%;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        background: #fff;
        padding: 8px 10px;
        font-size: 14px;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        max-height: 220px;
        overflow: auto;
        padding-right: 2px;
      }
      .chip {
        border: 1px solid #cbd5e1;
        border-radius: 999px;
        padding: 5px 9px;
        font-size: 12px;
        background: #f8fafc;
        color: #0f172a;
        cursor: pointer;
      }
      .chip.active {
        background: #2563eb;
        color: #fff;
        border-color: #2563eb;
      }
      .subtle {
        color: #64748b;
        font-size: 12px;
      }
      .panel {
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
        background: #f8fafc;
      }
      .panel strong {
        display: inline-block;
        margin-bottom: 6px;
      }
      .result-list {
        display: grid;
        gap: 10px;
      }
      .result-item {
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 10px;
      }
      .result-title {
        font-weight: 600;
        margin-bottom: 4px;
      }
      .status {
        font-size: 12px;
        margin-top: 2px;
      }
      .ok {
        color: #047857;
      }
      .warn {
        color: #b45309;
      }
      .bad {
        color: #b91c1c;
      }
      .score {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        margin-right: 6px;
        font-size: 12px;
      }
      .score-high {
        background: #dcfce7;
        color: #166534;
      }
      .score-mid {
        background: #e0f2fe;
        color: #0369a1;
      }
      .score-low {
        background: #fef9c3;
        color: #854d0e;
      }
      .small {
        font-size: 12px;
        color: #334155;
        margin-top: 4px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        font-size: 11px;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .btn-row {
        display: flex;
        gap: 8px;
      }
      .btn-row button {
        width: auto;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        font-size: 11px;
        border: 1px solid #bfdbfe;
        background: #eff6ff;
        color: #1d4ed8;
        border-radius: 8px;
        padding: 2px 6px;
        margin-left: 6px;
      }
      ul {
        margin: 8px 0 0 16px;
        padding: 0;
      }
      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .footer {
        margin-top: 10px;
        color: #64748b;
        font-size: 12px;
      }
      @media (max-width: 980px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .chips {
          max-height: none;
        }
      }
    </style>
  </head>
  <body>
    <h1>성취기준 우선 수업스케치 워크플로우</h1>
    <p class="subtitle">
      교사가 성취기준을 먼저 고르면, 추천 엔진 점수가 우선 정렬되는지와
      최종 후보가 어떻게 바뀌는지 확인합니다.
    </p>
    <p class="tiny">현재 데모 빌드: standards-json-first-2026-02-15</p>

    <div class="layout">
      <section class="card">
        <h3>1) 조건 설정</h3>

        <div class="row">
          <label>학년</label>
          <select id="grade"></select>
        </div>
        <div class="row">
          <label>영역(도메인)</label>
          <select id="domain"></select>
        </div>
        <div class="row">
          <label>세부 유형</label>
          <select id="subDomain"></select>
        </div>
        <div class="row">
          <label>종목</label>
          <select id="sport"></select>
        </div>
        <div class="row">
          <label>수업 공간</label>
          <select id="space"></select>
        </div>
        <div class="row">
          <label>수업 시간</label>
          <select id="duration"></select>
        </div>

        <h3>2) 성취기준 우선 설정</h3>
        <p class="small subtle" style="margin-bottom: 8px">
          [3-4학년군 성취기준] 기준으로 동작합니다. 하나 이상 선택하면 가중치가 누적됩니다.
        </p>
        <div id="guideList" class="chips"></div>

        <div class="btn-row" style="margin-top: 10px">
          <button id="runBtn">추천 재산출</button>
          <button id="clearBtn" type="button">성취기준 초기화</button>
        </div>
      </section>

      <section class="card">
        <h3>엔진 실행 로그/추천 후보</h3>
        <div id="pipeline"></div>
        <div id="candidates" class="result-list" style="margin-top: 10px"></div>
        <div class="footer">
          표시 규칙: 상단 점수는 성취기준 매칭 가중치 포함 점수입니다.
        </div>
      </section>
    </div>

    <section class="card" style="margin-top: 16px">
      <h3>3) 추천 워크플로우 요약</h3>
      <div id="workflowSummary" class="subtle"></div>
      <div id="traceLog" class="mono" style="margin-top: 8px; line-height: 1.5"></div>
    </section>

    <script type="module">
      import fmsCurriculum from '/src/data/modules/fmsCurriculum.json'
      import standardsData from '/src/data/curriculum/standards.json'
      import sportsData from '/src/data/modules/sports.json'
      import activitiesData from '/src/data/modules/activities.json'
      import skillsData from '/src/data/modules/skills.json'
      import { generateActivityCandidates, hasActivitiesForSport } from '/src/utils/recommend/activityEngine.js'
      import { generateModularCandidates } from '/src/utils/recommend/generateModularCandidates.js'

      const gradeEl = document.getElementById('grade')
      const domainEl = document.getElementById('domain')
      const subDomainEl = document.getElementById('subDomain')
      const sportEl = document.getElementById('sport')
      const spaceEl = document.getElementById('space')
      const durationEl = document.getElementById('duration')
      const guideList = document.getElementById('guideList')
      const pipelineEl = document.getElementById('pipeline')
      const candidatesEl = document.getElementById('candidates')
      const summaryEl = document.getElementById('workflowSummary')
      const traceEl = document.getElementById('traceLog')
      const runBtn = document.getElementById('runBtn')
      const clearBtn = document.getElementById('clearBtn')

      const DURATION_OPTIONS = [30, 35, 40, 45, 50]
      const DEFAULT_DURATION = 40
      const TRACE_MAX = 12

      const STANDARD_BAND_BY_GRADE = {
        '3학년': '3-4학년군',
        '4학년': '3-4학년군',
      }

      function uniq(items) {
        return [...new Set((items || []).filter(Boolean))]
      }

      function norm(value) {
        return String(value ?? '')
          .replace(/\s+/g, '')
          .replace(/[가-힣]/g, '')
          .toLowerCase()
      }

      function toLowerNoSpace(value) {
        return String(value ?? '').replace(/\s+/g, '').toLowerCase()
      }

      function containsAny(text, terms) {
        const normalized = toLowerNoSpace(text)
        return terms.some((term) => normalized.includes(toLowerNoSpace(term)))
      }

      function fillSelect(el, values) {
        el.innerHTML = ''
        values.forEach((value) => {
          const option = document.createElement('option')
          option.value = option.textContent = value
          el.appendChild(option)
        })
      }

      function getSportByName(name) {
        return sportsData.sports.find((sport) => sport.name === name)
      }

      function getSportsByDomain(domain, subDomain) {
        return sportsData.sports
          .filter((sport) => sport.domain === domain && sport.subDomain === subDomain)
          .map((sport) => sport.name)
      }

      function getDomains() {
        return uniq(sportsData.sports.map((s) => s.domain))
      }

      function getSubDomains(domain) {
        return uniq(sportsData.sports.filter((s) => s.domain === domain).map((s) => s.subDomain))
      }

      function getStandardBand(grade) {
        const band = STANDARD_BAND_BY_GRADE[grade]
        const defaultBand = Object.keys(standardsData.gradeBands || {})[0]
        return {
          band: band || defaultBand,
          isFallback: !band && Boolean(defaultBand),
        }
      }

      function getStandardsForGrade(grade, domain) {
        const { band: gradeBand, isFallback } = getStandardBand(grade)
        const bandData = standardsData.gradeBands?.[gradeBand]
        if (!bandData) return []

        const domainStandards = domain
          ? Object.entries(bandData)
            .filter(([key]) => key === domain)
            .flatMap(([domainName, domainValue]) =>
              (domainValue.standards || []).map((item) => ({ ...item, sourceDomain: domainName }))
            )
          : []
        const allStandards = Object.entries(bandData).flatMap(([domainName, domainValue]) =>
          (domainValue.standards || []).map((item) => ({ ...item, sourceDomain: domainName }))
        )

        const source = domainStandards.length ? domainStandards : allStandards
        return source.map((item, index) => ({
          ...item,
          standardId: item.code,
          standardText: item.text,
          order: index + 1,
          gradeBand,
          isFallback,
        }))
      }

      function getGradeOptions() {
        return Object.keys(fmsCurriculum.gradeProgression || {}).sort((a, b) => a.localeCompare(b))
      }

      const guideSelection = new Set()
      const traceLogs = []
      const activityById = new Map(activitiesData.activities.map((a) => [a.id, a]))
      const skillByName = new Map(skillsData.skills.map((s) => [s.name, s]))

      function getSportSkills(grade, sportName, space) {
        const sport = getSportByName(sportName)
        if (!sport?.skills?.length) return []
        const skillIds = new Set(sport.skills)
        return skillsData.skills
          .filter((skill) => {
            if (!skillIds.has(skill.id)) return false
            if (!skill.gradeRange.includes(grade)) return false
            if (!skill.spaceNeeded.includes(space)) return false
            return true
          })
          .map((skill) => skill.name)
      }

      function pushTrace(text) {
        traceLogs.unshift(text)
        while (traceLogs.length > TRACE_MAX) traceLogs.length = TRACE_MAX
        traceEl.textContent = traceLogs.join('\n')
      }

      function getStandardTextPool(standard) {
        const content = standard.contentElements || {}
        return [
          standard.code,
          standard.text,
          standard.explanation,
          ...(content.knowledge || []),
          ...(content.process || []),
          ...(content.values || []),
        ]
      }

      function standardToTerms(standard) {
        return getStandardTextPool(standard).filter(Boolean)
      }

      function buildCandidateScore(candidate, selectedStandards) {
        const activity = activityById.get(candidate.activityId) || {}
        const raw = [candidate.title, candidate.activityName, candidate.activityId, candidate.description, ...(candidate.basicRules || []), ...(activity.flow || []), ...(candidate.operationTips || [])].join(' ')
        let score = candidate.score || 0
        const detail = []
        const matchedStandards = []
        selectedStandards.forEach((standard) => {
          const terms = standardToTerms(standard)
          if (terms.length === 0) return
          let matched = false
          let added = 0

          const fmsTags = candidate.fmsTags || []
          const curriculumTags = standard.fmsCategories || []
          if (fmsTags.length && curriculumTags.some((tag) => fmsTags.includes(tag))) {
            score += 15
            added += 15
            matched = true
          }

          if (containsAny(raw, terms)) {
            score += 10
            added += 10
            matched = true
          }

          const codeTag = standard.code || ''
          if (codeTag && raw.includes(codeTag)) {
            score += 8
            added += 8
            matched = true
          }

          if (matched) {
            matchedStandards.push(`${standard.code}: +${added}`)
            detail.push(`성취기준 ${standard.code} (${standard.text}) ${standard.explanation ? '—' : ''} ${added ? `+${added}` : ''}`)
          }
        })

        const scoreClass = score >= 45 ? 'score-high' : score >= 25 ? 'score-mid' : 'score-low'
        return {
          priorityScore: score,
          scoreClass,
          scoreDetail: detail.slice(0, 5),
          matchedStandards,
        }
      }

      const standardsById = new Map()
      let lastSummary = ''

      function renderGuides(grade) {
        guideList.innerHTML = ''
        const standards = getStandardsForGrade(grade, domainEl.value)
        standardsById.clear()
        standards.forEach((standard) => {
          standardsById.set(standard.standardId, standard)
          const button = document.createElement('button')
          button.type = 'button'
          button.className = 'chip'
          button.textContent = `${standard.standardId} · ${standard.standardText}`
          button.title = `${standard.sourceDomain || domainEl.value}${standard.explanation ? ` / ${standard.explanation}` : ''}`
          button.onclick = () => {
            if (standardsById.has(standard.standardId) && guideSelection.has(standard.standardId)) {
              guideSelection.delete(standard.standardId)
              button.classList.remove('active')
            } else {
              guideSelection.add(standard.standardId)
              button.classList.add('active')
            }
            runRecommendation()
          }
          guideList.appendChild(button)
          button.dataset.id = standard.standardId
        })
        if (standards.length > 0) {
          const first = standards[0]
          guideList.firstElementChild?.classList.add('active')
          guideSelection.add(first.standardId)
        }
      }

      function getSelectedStandards() {
        return [...guideSelection].map((id) => standardsById.get(id)).filter(Boolean)
      }

      function scoreLabel(value) {
        if (value >= 60) return '매우 적합'
        if (value >= 35) return '적합'
        return '보조참조'
      }

      function renderCandidateList(candidates, selectedStandards) {
        candidatesEl.innerHTML = ''
        if (candidates.length === 0) {
          const empty = document.createElement('div')
          empty.className = 'result-item'
          empty.innerHTML = `
            <div class="result-title">추천 후보가 없습니다.</div>
            <p class="small warn">현재 조건으로는 후보 생성이 되지 않습니다. 상위 조건을 넓혀 보세요.</p>
          `
          candidatesEl.appendChild(empty)
          return
        }

        candidates.forEach((candidate, idx) => {
          const scoreInfo = buildCandidateScore(candidate, selectedStandards)
          const flow = (candidate.compiledFlow || candidate.compiledTemplate || []).slice(0, 3)
          const card = document.createElement('div')
          card.className = 'result-item'
          const detailRows = scoreInfo.scoreDetail.length
            ? `<ul>${scoreInfo.scoreDetail.map((row) => `<li>${row}</li>`).join('')}</ul>`
            : '<p class="small">직접 선택 시 기본 점수 기반 정렬</p>'
          const matched = scoreInfo.matchedStandards.length
            ? `<p class="small">성취기준 매칭: ${scoreInfo.matchedStandards.join(', ')}</p>`
            : ''
          const meta = [
            candidate.sport,
            candidate.activityName ? `${candidate.activityName}` : '',
            `기본점수 ${candidate.score ?? 0}`,
          ].filter(Boolean).join(' / ')
          card.innerHTML = `
            <div class="result-title">
              <span class="score ${scoreInfo.scoreClass}">${scoreInfo.priorityScore}p</span>
              ${candidate.titleWithOrder || `후보 ${idx + 1}`}
              <span class="badge">성취기준 적합도: ${scoreLabel(scoreInfo.priorityScore)}</span>
            </div>
            <p class="small">${meta}</p>
            <p class="small">${(candidate.basicRules || []).slice(0, 2).join(' / ') || '기본 규칙: 내부 템플릿 기본 적용'}</p>
            <p class="small">${(candidate.teachingCues || []).slice(0, 3).join(' · ') || '교사용 지도 포인트 미정'}</p>
            ${detailRows}
            ${matched}
            <p class="status ${idx % 2 === 0 ? 'ok' : 'subtle'}">
              ${flow.length ? `흐름 핵심: ${flow.join(' → ')}` : '흐름 데이터 없음'}
            </p>
          `
          candidatesEl.appendChild(card)
        })
      }

      function renderPipeline(grade, sport, space, selectedStandards, csvRes, moduleRes, usedEngine, finalCandidates) {
        const gradeConfig = fmsCurriculum.gradeProgression?.[grade]
        const allowPhases = (gradeConfig?.allowedPhases || []).join(', ') || '없음'
        const standardBand = selectedStandards[0]?.gradeBand || getStandardBand(grade).band
        const standardFallback = selectedStandards.some((item) => item.isFallback)
          ? ' (3-4학년군 대체 적용)'
          : ''
        const standardNames = selectedStandards.map((g) => `${g.standardId} ${g.standardText || ''}`)
        const guideDesc = standardNames.length
          ? standardNames.join(', ')
          : '미선택(기본 템플릿 가중치만 적용)'

        const csvReady = hasActivitiesForSport(sport)
        const moduleReady = Boolean(moduleRes?.meta?.structureCount)

        pipelineEl.innerHTML = `
          <div class="panel">
            <strong>현재 조건</strong>
            <p class="small subtle">${grade} / ${sport} / ${space} / ${durationEl.value}분</p>
            <p class="small">성취기준군: ${standardBand}${standardFallback}</p>
            <p class="small">허용 단계: ${allowPhases}</p>
            <p class="small">변형 허용: 최대 ${gradeConfig?.maxModifierCount ?? 0}개</p>
            <p class="small">성취기준: ${guideDesc}</p>
          </div>
          <div class="panel">
            <strong>CSV 활동 엔진</strong>
            <p class="status ${csvRes.candidates.length > 0 ? 'ok' : 'bad'}">
              ${csvRes.candidates.length > 0 ? '진입' : '차단'}
            </p>
            <p class="small">후보 수: ${csvRes.candidates.length} / 활동 수: ${csvRes.meta?.activityCount ?? 0}</p>
            <p class="small">가드: hasActivitiesForSport=${csvReady}</p>
            ${csvRes.meta?.reason ? `<p class="small warn">사유: ${csvRes.meta.reason}</p>` : ''}
          </div>
          <div class="panel">
            <strong>모듈 엔진</strong>
            <p class="status ${moduleRes.candidates.length > 0 ? 'ok' : 'bad'}">
              ${moduleRes.candidates.length > 0 ? '진입' : '차단'}
            </p>
            <p class="small">구조/기술 후보: ${moduleRes.meta?.structureCount ?? 0} / ${moduleRes.meta?.skillCount ?? 0}</p>
            <p class="small">실패사유 top: ${(moduleRes.meta?.topFailureReasons || []).map((item) => item.reason).join(', ') || '없음'}</p>
          </div>
          <div class="panel">
            <strong>최종 결과</strong>
            <p class="status ${finalCandidates.length > 0 ? 'ok' : 'bad'}">${finalCandidates.length > 0 ? '완료' : '후보 없음'}</p>
            <p class="small">실행 엔진: ${usedEngine || '확인 필요'}</p>
          </div>
          <p class="small subtle">정렬: 성취기준 가중치 점수(내림차순) → 동일 시 엔진 점수(내림차순)</p>
        `
      }

      function renderSummary(grade, sport, space, usedEngine, finalCount) {
        const selectedStandards = getSelectedStandards()
        const guideText = selectedStandards
          .map((standard) => `· ${standard.standardId}: ${standard.standardText}`)
          .join('\n')
        const steps = [
          '1) 조건(학년/종목/공간) 설정',
          `2) ${selectedStandards.length}개 성취기준 우선 가중치 적용`,
          `3) CSV 엔진 1차 호출${usedEngine === 'csv' ? ' (성공)' : ' (필요 시 모듈로 전환)'}`,
          '4) 최종 후보 상위 5개 표시',
          `5) 상위 후보를 기반으로 차시 활동 편집/최적화 실행`,
        ].join('\n')
        summaryEl.textContent = `${grade} ${sport} ${space} 조건에서 성취기준이 반영된 우선순위 순번으로 추천됩니다.`
        traceEl.textContent = `${steps}\n---\n${guideText || '성취기준 미선택: 기본 규칙 기반 추천'}`
      }

      function mergeRecommendationCandidates(csvResult, moduleResult, selectedGuides) {
        if (csvResult.candidates?.length) {
          const candidates = csvResult.candidates.map((c) => ({ ...c, _engine: 'csv' }))
          const enriched = candidates.map((c) => {
            const scoreInfo = buildCandidateScore(c, selectedGuides)
            return {
              ...c,
              _priorityScore: scoreInfo.priorityScore,
              _scoreClass: scoreInfo.scoreClass,
            }
          })
        const sorted = enriched
          .sort((a, b) => {
            if (b._priorityScore !== a._priorityScore) return b._priorityScore - a._priorityScore
            if ((b.score || 0) !== (a.score || 0)) return (b.score || 0) - (a.score || 0)
            return (a.activityName || '').localeCompare(b.activityName || '')
          })
          .slice(0, 5)
        return { candidates: sorted, usedEngine: 'csv', raw: csvResult }
      }

        if (moduleResult.candidates?.length) {
          const enriched = moduleResult.candidates.map((c) => {
            const scoreInfo = buildCandidateScore(c, selectedGuides)
            return {
              ...c,
              _priorityScore: scoreInfo.priorityScore,
              _scoreClass: scoreInfo.scoreClass,
            }
          })
          const sorted = enriched
          .sort((a, b) => {
            if (b._priorityScore !== a._priorityScore) return b._priorityScore - a._priorityScore
            if ((b.score || 0) !== (a.score || 0)) return (b.score || 0) - (a.score || 0)
            return (a.activityName || '').localeCompare(b.activityName || '')
          })
          .slice(0, 5)
        return { candidates: sorted, usedEngine: 'modular', raw: moduleResult }
      }

        return { candidates: [], usedEngine: 'fallback', raw: { candidates: [] } }
      }

      function runRecommendation() {
        const grade = gradeEl.value
        const sport = sportEl.value
        const space = spaceEl.value
        const durationMin = Number(durationEl.value || DEFAULT_DURATION)

        const req = {
          grade,
          sport,
          space,
          domain: domainEl.value,
          subDomain: subDomainEl.value,
          durationMin,
          fmsFocus: [],
          sportSkills: getSportSkills(grade, sport, space),
          classSize: 24,
          availableEquipment: [],
          lessonHistory: [],
          maxCandidates: 8,
        }

        const selectedStandards = getSelectedStandards()
        const guideText = selectedStandards.length
          ? selectedStandards.map((g) => `${g.standardId} ${g.standardText}`).join(', ')
          : '선택 없음'
        pushTrace(`요청 생성: ${grade}/${sport}/${space}/${durationMin}분`)
        pushTrace(`성취기준 선택: ${guideText}`)

        const csvResult = generateActivityCandidates(req)
        const modularResult = generateModularCandidates(req)

        const merged = mergeRecommendationCandidates(csvResult, modularResult, selectedStandards)
        const usedEngine = merged.usedEngine
        const finalCandidates = merged.candidates

        renderPipeline(grade, sport, space, selectedStandards, csvResult, modularResult, usedEngine, finalCandidates)
        renderSummary(grade, sport, space, usedEngine, finalCandidates.length)
        renderCandidateList(finalCandidates, selectedStandards)

        if (finalCandidates.length === 0) {
          pushTrace(`최종 상태: 후보 없음. CSV=${csvResult.candidates.length}, 모듈=${modularResult.candidates.length}`)
        } else {
          pushTrace(`최종 선택: ${finalCandidates[0]?.title} (${finalCandidates[0]?._engine})`)
        }
      }

      function refreshGradeContext() {
        const grade = gradeEl.value
        renderGuides(grade)
      }

      function refreshSubDomains() {
        const domains = getSubDomains(domainEl.value)
        fillSelect(subDomainEl, domains)
        if (!domains.includes(subDomainEl.value)) {
          subDomainEl.value = domains[0]
        }
      }

      function refreshSports() {
        const sports = getSportsByDomain(domainEl.value, subDomainEl.value)
        fillSelect(sportEl, sports)
        if (!sports.includes(sportEl.value) && sports.length > 0) sportEl.value = sports[0]
      }

      function resetGuideSelection() {
        guideSelection.clear()
      }

      function init() {
        const grades = getGradeOptions()
        const domains = getDomains()
        fillSelect(gradeEl, grades)
        fillSelect(durationEl, DURATION_OPTIONS.map((d) => String(d)))
        fillSelect(spaceEl, ['운동장', '체육관', '교실'])
        fillSelect(domainEl, domains)

        if (!grades.includes('3학년')) {
          gradeEl.value = grades[0]
        }

        refreshSubDomains()
        refreshSports()
        gradeEl.value = '3학년'
        durationEl.value = String(DEFAULT_DURATION)
        spaceEl.value = '운동장'

        refreshGradeContext()
        runRecommendation()
      }

      gradeEl.addEventListener('change', () => {
        refreshGradeContext()
        runRecommendation()
      })

      domainEl.addEventListener('change', () => {
        resetGuideSelection()
        refreshSubDomains()
        refreshSports()
        refreshGradeContext()
        runRecommendation()
      })

      subDomainEl.addEventListener('change', () => {
        resetGuideSelection()
        refreshSports()
        refreshGradeContext()
        runRecommendation()
      })

      sportEl.addEventListener('change', runRecommendation)
      spaceEl.addEventListener('change', runRecommendation)
      durationEl.addEventListener('change', runRecommendation)
      runBtn.addEventListener('click', runRecommendation)
      clearBtn.addEventListener('click', () => {
        resetGuideSelection()
        const guides = getStandardsForGrade(gradeEl.value, domainEl.value)
        if (guides.length > 0) guideSelection.add(guides[0].standardId)
        [...guideList.children].forEach((el) => el.classList.remove('active'))
        const first = guideList.firstElementChild
        if (first) first.classList.add('active')
        runRecommendation()
      })

      init()
    </script>
  </body>
</html>
