<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-store, no-cache, must-revalidate, max-age=0"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>수업스케치 미리보기 (단일)</title>
    <style>
      :root {
        color-scheme: light;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        padding: 20px;
        font-family: Inter, Pretendard, Arial, sans-serif;
        background: #f4f7fb;
        color: #111827;
      }
      h1,h2,h3 { margin: 0 0 10px; }
      p { margin: 0; }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        display: grid;
        gap: 14px;
      }
      .top-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .btn {
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        background: #fff;
        font-size: 13px;
      }
      .grid {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 14px;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 14px;
        box-shadow: 0 4px 12px rgba(15,23,42,.06);
      }
      .row { margin-bottom: 10px; }
      label {
        display: block;
        margin-bottom: 5px;
        color: #475569;
        font-size: 12px;
      }
      select, button, textarea {
        width: 100%;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 9px;
        font-size: 13px;
        background: #fff;
      }
      .badge {
        display: inline-block;
        margin-left: 6px;
        border: 1px solid #bfdbfe;
        border-radius: 999px;
        background: #eff6ff;
        color: #1d4ed8;
        padding: 2px 8px;
        font-size: 11px;
      }
      .status {
        font-size: 12px;
        margin: 8px 0 0;
        color: #475569;
      }
      .score {
        font-size: 12px;
        margin-left: 6px;
        padding: 2px 6px;
        border-radius: 999px;
      }
      .ok { color: #065f46; background: #d1fae5; }
      .warn { color: #b45309; background: #fef3c7; }
      .bad { color: #b91c1c; background: #fee2e2; }
      .subtle { color: #64748b; font-size: 12px; }
      .candidate-list {
        display: grid;
        gap: 8px;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        max-height: 150px;
        overflow: auto;
      }
      .candidate {
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 10px;
        cursor: pointer;
      }
      .candidate.active {
        border-color: #2563eb;
        background: #eff6ff;
      }
      .candidate h4 { margin: 0 0 6px; font-size: 14px; }
      .small {
        color: #334155;
        font-size: 12px;
        line-height: 1.5;
      }
      .tiny {
        color: #64748b;
        font-size: 11px;
      }
      .muted { color: #64748b; font-size: 12px; }
      ul { margin: 6px 0 0 18px; padding: 0; }
      .section-title {
        font-size: 12px;
        color: #475569;
        margin-bottom: 4px;
      }
      .chip {
        border: 1px solid #cbd5e1;
        border-radius: 999px;
        padding: 5px 9px;
        font-size: 11px;
        background: #f8fafc;
        color: #0f172a;
        cursor: pointer;
      }
      .chip.active {
        background: #2563eb;
        color: #fff;
        border-color: #2563eb;
      }
      @media (max-width: 960px) {
        .grid { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top-actions">
      <h1>수업스케치 단일 HTML 미리보기</h1>
      <button class="btn" id="refreshBtn" type="button">새로고침</button>
      </div>
      <p class="subtle">학교선택/위저드 없이 수업스케치 추천 엔진만 바로 확인합니다.</p>
      <p class="tiny">현재 데모 빌드: standards-json-first-2026-02-15</p>
      <p class="tiny">캐시 이슈 시 이 주소로 접속: <code>/lesson-sketch-only-preview.html?v=sketch</code></p>

      <div class="grid">
        <section class="card">
          <h3>추천 조건</h3>
          <div class="row">
            <label>학년</label>
            <select id="grade"></select>
          </div>
          <div class="row">
            <label>성취기준</label>
            <div id="standardChips" class="chips"></div>
          </div>
          <div class="row">
            <label>도메인</label>
            <select id="domain"></select>
          </div>
          <div class="row">
            <label>세부유형</label>
            <select id="subDomain"></select>
          </div>
          <div class="row">
            <label>종목</label>
            <select id="sport"></select>
          </div>
          <div class="row">
            <label>수업 공간</label>
            <select id="space"></select>
          </div>
          <div class="row">
            <label>수업 시간</label>
            <select id="duration"></select>
          </div>
          <div class="row">
            <label>클래스 인원</label>
            <select id="classSize"></select>
          </div>
          <button class="btn" id="runBtn" type="button">수업스케치 생성</button>
          <p id="pipeline" class="status"></p>
        </section>

        <section class="card">
          <h3>추천 후보</h3>
          <div id="candidates" class="candidate-list"></div>
          <p id="emptyMsg" class="muted"></p>
        </section>
      </div>

      <section class="card">
        <h3>선택 후보 상세</h3>
        <div id="detail">생성 후 카드에서 후보를 클릭하세요.</div>
      </section>
    </div>

    <script type="module">
      import fmsCurriculum from '/src/data/modules/fmsCurriculum.json'
      import standardsData from '/src/data/curriculum/standards.json'
      import sportsData from '/src/data/modules/sports.json'
      import skillsData from '/src/data/modules/skills.json'
      import { generateActivityCandidates } from '/src/utils/recommend/activityEngine.js'
      import { generateModularCandidates } from '/src/utils/recommend/generateModularCandidates.js'

      const gradeEl = document.getElementById('grade')
      const domainEl = document.getElementById('domain')
      const subDomainEl = document.getElementById('subDomain')
      const sportEl = document.getElementById('sport')
      const spaceEl = document.getElementById('space')
      const durationEl = document.getElementById('duration')
      const classSizeEl = document.getElementById('classSize')
      const runBtn = document.getElementById('runBtn')
      const refreshBtn = document.getElementById('refreshBtn')
      const standardChipsEl = document.getElementById('standardChips')
      const pipelineEl = document.getElementById('pipeline')
      const candidatesEl = document.getElementById('candidates')
      const detailEl = document.getElementById('detail')
      const emptyEl = document.getElementById('emptyMsg')

      const DURATION_OPTIONS = [30, 35, 40, 45, 50, 55]
      const CLASS_SIZES = [12, 18, 24, 30, 36]
      const SPACES = ['운동장', '체육관', '교실']

      function uniq(items) {
        return [...new Set((items || []).filter(Boolean))]
      }

      function getDomains() {
        return uniq(sportsData.sports.map((x) => x.domain))
      }

      const STANDARD_BAND_BY_GRADE = {
        '3학년': '3-4학년군',
        '4학년': '3-4학년군',
      }

      function toNoSpace(value) {
        return String(value ?? '').replace(/\s+/g, '').toLowerCase()
      }

      function containsAny(text, terms) {
        const normalized = toNoSpace(text)
        return terms.some((term) => normalized.includes(toNoSpace(term)))
      }

      function getStandardBand(grade) {
        const band = STANDARD_BAND_BY_GRADE[grade]
        const defaultBand = Object.keys(standardsData.gradeBands || {})[0]
        return { band: band || defaultBand, isFallback: !band && Boolean(defaultBand) }
      }

      function getStandardsForGrade(grade, domain) {
        const { band: gradeBand, isFallback } = getStandardBand(grade)
        const bandData = standardsData.gradeBands?.[gradeBand]
        if (!bandData) return []

        const domainStandards = domain
          ? Object.entries(bandData)
            .filter(([key]) => key === domain)
            .flatMap(([domainName, domainValue]) =>
              (domainValue.standards || []).map((item) => ({ ...item, sourceDomain: domainName }))
            )
          : []
        const allStandards = Object.entries(bandData).flatMap(([domainName, domainValue]) =>
          (domainValue.standards || []).map((item) => ({ ...item, sourceDomain: domainName }))
        )

        const source = domainStandards.length ? domainStandards : allStandards
        return source.map((item, index) => ({
          ...item,
          standardId: item.code,
          standardText: item.text,
          order: index + 1,
          gradeBand,
          isFallback,
        }))
      }

      function getSubDomains(domain) {
        return uniq(sportsData.sports.filter((s) => s.domain === domain).map((s) => s.subDomain))
      }

      function getSports(domain, subDomain) {
        return sportsData.sports
          .filter((s) => s.domain === domain && s.subDomain === subDomain)
          .map((s) => s.name)
      }

      function getSportByName(name) {
        return sportsData.sports.find((s) => s.name === name)
      }

      function getSportSkills(grade, sportName, space) {
        const sport = getSportByName(sportName)
        if (!sport?.skills?.length) return []
        const skillIds = new Set(sport.skills)
        return skillsData.skills
          .filter((skill) => {
            if (!skillIds.has(skill.id)) return false
            if (!skill.gradeRange.includes(grade)) return false
            if (!skill.spaceNeeded.includes(space)) return false
            return true
          })
          .map((skill) => skill.name)
      }

      function fill(el, values) {
        el.innerHTML = ''
        values.forEach((value) => {
          const option = document.createElement('option')
          option.value = value
          option.textContent = value
          el.appendChild(option)
        })
      }

      const selectedStandardIds = new Set()
      const standardsById = new Map()

      function renderStandardChips(grade) {
        const standards = getStandardsForGrade(grade, domainEl.value)
        standardChipsEl.innerHTML = ''
        standardsById.clear()

        standards.forEach((standard) => {
          standardsById.set(standard.standardId, standard)
          const btn = document.createElement('button')
          btn.type = 'button'
          btn.className = 'chip'
          btn.textContent = `${standard.standardId} ${standard.standardText}`
          btn.title = `${standard.explanation || standard.sourceDomain || ''}`
          btn.onclick = () => {
            if (selectedStandardIds.has(standard.standardId)) {
              selectedStandardIds.delete(standard.standardId)
              btn.classList.remove('active')
            } else {
              selectedStandardIds.add(standard.standardId)
              btn.classList.add('active')
            }
            run()
          }
          standardChipsEl.appendChild(btn)
        })

        if (standards.length > 0) {
          selectedStandardIds.clear()
          selectedStandardIds.add(standards[0].standardId)
          const firstBtn = standardChipsEl.firstElementChild
          if (firstBtn) firstBtn.classList.add('active')
        }
      }

      function getSelectedStandards() {
        return [...selectedStandardIds].map((id) => standardsById.get(id)).filter(Boolean)
      }

      function getGradeConfig(grade) {
        return fmsCurriculum.gradeProgression?.[grade] || null
      }

      function buildDefaultFlow(candidate) {
        const flow = candidate.compiledFlow || candidate.templateText || []
        if (!flow.length) {
          return ['흐름 데이터가 없어 교사가 활동 단계를 수동 구성해 주세요.']
        }
        return flow
      }

      function buildStandardScore(candidate, selectedStandards) {
        const flowSource = candidate.compiledFlow || candidate.templateText || []
        const raw = [candidate.title, candidate.activityName, candidate.description, ...(candidate.basicRules || []), ...(flowSource || []), ...(candidate.operationTips || [])].join(' ')
        let score = candidate.score || 0
        const matched = []

        selectedStandards.forEach((standard) => {
          const terms = [
            standard.code,
            standard.text,
            standard.explanation,
            ...((standard.contentElements?.knowledge || [])),
            ...((standard.contentElements?.process || [])),
            ...((standard.contentElements?.values || [])),
          ].filter(Boolean)

          let plus = 0
          if ((standard.fmsCategories || []).some((tag) => (candidate.fmsTags || []).includes(tag))) {
            plus += 12
          }
          if (containsAny(raw, terms)) {
            plus += 10
          }
          if (standard.code && raw.includes(standard.code)) {
            plus += 6
          }
          if (plus > 0) {
            score += plus
            matched.push(`${standard.code}(+${plus})`)
          }
        })

        return {
          priorityScore: score,
          matched,
          label: score >= 45 ? '매우 적합' : score >= 35 ? '적합' : '보조',
        }
      }

      function scoreLabel(score) {
        if (score >= 45) return '매우 적합'
        if (score >= 35) return '적합'
        return '보조'
      }

      function renderDetail(candidate, selectedStandards = []) {
        if (!candidate) {
          detailEl.textContent = '선택된 후보가 없습니다.'
          return
        }

        const flow = buildDefaultFlow(candidate)
        const scoreInfo = buildStandardScore(candidate, selectedStandards)

        detailEl.innerHTML = `
          <div class="section-title">기본 정보</div>
          <h2>${candidate.titleWithOrder || candidate.title || candidate.activityName || '후보'}</h2>
          <p class="small">${candidate.sport || candidate.activityName || ''} · ${candidate.difficulty || '중간'}</p>
          <p class="small">
            기본 규칙: ${(candidate.basicRules || []).slice(0, 3).join(' / ') || '기본 규칙 미기재'}
          </p>
          <p class="small">
            성취기준 반영 점수: <span class="score ok">${scoreInfo.priorityScore}점</span>
            매칭: <span class="score ok">${scoreInfo.label}</span>
            난이도: ${candidate.difficulty || '-'}
          </p>
          <p class="small">${scoreInfo.matched.length ? `매칭 성취기준: ${scoreInfo.matched.join(', ')}` : '성취기준 매칭 없음'}</p>

          <div style="margin-top:10px">
            <div class="section-title">교사용 가이드</div>
            <p class="small">${(candidate.teachingCues || []).slice(0, 4).join(' / ') || '교사 큐 데이터 없음'}</p>
          </div>
          <div style="margin-top:8px">
            <div class="section-title">흐름</div>
            <ul>${flow.slice(0, 5).map((step) => `<li>${step}</li>`).join('')}</ul>
          </div>
          <div style="margin-top:8px">
            <div class="section-title">안전 및 운영 포인트</div>
            <p class="small">${(candidate.operationTips || []).slice(0, 4).join(' / ') || '안전 포인트 미기재'}</p>
          </div>
          <div style="margin-top:8px">
            <div class="section-title">요약 링크</div>
            <p class="small"><a href="${candidate.youtubeUrl || '#'}" target="_blank" rel="noreferrer">추천 유튜브 검색 보기</a></p>
          </div>
        `
      }

      function renderCandidates(candidates) {
        const selectedStandards = getSelectedStandards()
        candidatesEl.innerHTML = ''
        if (!candidates.length) {
          emptyEl.textContent = '현재 조건에서 후보가 없습니다. 종목/공간/학년 조합을 바꿔 보세요.'
          return
        }
        emptyEl.textContent = ''
        candidates.forEach((candidate, index) => {
          const scoreInfo = buildStandardScore(candidate, selectedStandards)
          const card = document.createElement('div')
          const flow = buildDefaultFlow(candidate)
          card.className = 'candidate'
          card.dataset.id = candidate.id
          card.onclick = () => {
            [...candidatesEl.children].forEach((el) => el.classList.remove('active'))
            card.classList.add('active')
            renderDetail(candidate, selectedStandards)
          }

          card.innerHTML = `
            <h4>${index + 1}. ${candidate.titleWithOrder || candidate.title || candidate.activityName || ''}</h4>
            <p class="small">스페이스: ${candidate.location || candidate.locationSummary || '-'}</p>
            <p class="small">성취기준 반영 점수: <span class="score ok">${scoreInfo.priorityScore}점</span>
              <span class="badge">매칭 ${scoreLabel(scoreInfo.priorityScore)}</span>
            </p>
            <p class="small">기초규칙: ${(candidate.basicRules || []).slice(0, 2).join(' / ') || '미기재'}</p>
            <p class="small">성취기준 매칭: ${scoreInfo.matched.length ? scoreInfo.matched.join(', ') : '없음'}</p>
            <p class="tiny">흐름 시작: ${flow[0] || '-'}</p>
          `
          candidatesEl.appendChild(card)
        })

        candidatesEl.firstElementChild?.classList.add('active')
        renderDetail(candidates[0], selectedStandards)
      }

      function mergeCandidates(csvResult, modularResult) {
        if (csvResult?.candidates?.length) {
          return { candidates: csvResult.candidates, engine: `CSV (${csvResult.meta?.engine || 'activity-csv'})`, meta: csvResult.meta }
        }
        if (modularResult?.candidates?.length) {
          return { candidates: modularResult.candidates, engine: `모듈 (${modularResult.meta?.engine || 'modular'})`, meta: modularResult.meta }
        }
        return { candidates: [], engine: 'fallback', meta: modularResult?.meta || csvResult?.meta || {} }
      }

      function run() {
        const grade = gradeEl.value
        const sport = sportEl.value
        const space = spaceEl.value
        const domain = domainEl.value
        const subDomain = subDomainEl.value
        const durationMin = Number(durationEl.value || 40)
        const classSize = Number(classSizeEl.value || 24)
        const selectedSportSkills = getSportSkills(grade, sport, space)

        const req = {
          grade,
          domain,
          subDomain,
          sport,
          space,
          fmsFocus: [],
          sportSkills: selectedSportSkills,
          durationMin,
          classSize,
          availableEquipment: [],
          lessonHistory: [],
          maxCandidates: 8,
        }

        const gradeConfig = getGradeConfig(grade)
        const maxModifierCount = gradeConfig?.maxModifierCount ?? 0
        const allowedPhases = (gradeConfig?.allowedPhases || []).join(' / ')

        const csvResult = generateActivityCandidates(req)
        const modularResult = generateModularCandidates(req)
        const merged = mergeCandidates(csvResult, modularResult)
        const selectedStandards = getSelectedStandards()

        const sorted = merged.candidates
          .map((candidate) => {
            const scoreInfo = buildStandardScore(candidate, selectedStandards)
            return { ...candidate, priorityScore: scoreInfo.priorityScore }
          })
          .slice()
          .sort((a, b) => (b.priorityScore || 0) - (a.priorityScore || 0))

        pipelineEl.innerHTML = `
          <span class="score ok">${merged.engine}</span>
          후보: ${sorted.length}개 · 학년: ${grade} · 종목: ${sport} · 공간: ${space}
          <br />
          허용단계: ${allowedPhases || '없음'} / 변형: 최대 ${maxModifierCount}개
          <br />
          성취기준: ${selectedStandards.length ? selectedStandards.map((standard) => standard.standardId).join(', ') : '미선택(기본 가중치만 적용)'}
        `
        renderCandidates(sorted)
      }

      function init() {
        fill(gradeEl, Object.keys(fmsCurriculum.gradeProgression || {}))
        fill(domainEl, getDomains())
        fill(durationEl, DURATION_OPTIONS.map((value) => String(value)))
        fill(classSizeEl, CLASS_SIZES.map((value) => String(value)))
        fill(spaceEl, SPACES)
        durationEl.value = '40'
        classSizeEl.value = '24'

        if (getDomains().length > 0) {
          domainEl.value = getDomains()[0]
        }
        fill(subDomainEl, getSubDomains(domainEl.value))
        if (subDomainEl.options.length > 0) {
          subDomainEl.value = subDomainEl.options[0].value
        }
        fill(sportEl, getSports(domainEl.value, subDomainEl.value))
        if (sportEl.options.length > 0) {
          sportEl.value = sportEl.options[0].value
        }
        renderStandardChips(gradeEl.value)

        if (!gradeEl.value) {
          gradeEl.value = '3학년'
        }

        run()
      }

      domainEl.addEventListener('change', () => {
        fill(subDomainEl, getSubDomains(domainEl.value))
        if (subDomainEl.options.length > 0) {
          subDomainEl.value = subDomainEl.options[0].value
        }
        fill(sportEl, getSports(domainEl.value, subDomainEl.value))
        if (sportEl.options.length > 0) {
          sportEl.value = sportEl.options[0].value
        }
        renderStandardChips(gradeEl.value)
        run()
      })

      subDomainEl.addEventListener('change', () => {
        fill(sportEl, getSports(domainEl.value, subDomainEl.value))
        if (sportEl.options.length > 0) {
          sportEl.value = sportEl.options[0].value
        }
        renderStandardChips(gradeEl.value)
        run()
      })

      sportEl.addEventListener('change', run)
      spaceEl.addEventListener('change', run)
      gradeEl.addEventListener('change', () => {
        renderStandardChips(gradeEl.value)
        run()
      })
      durationEl.addEventListener('change', run)
      classSizeEl.addEventListener('change', run)
      runBtn.addEventListener('click', run)
      refreshBtn.addEventListener('click', () => {
        window.location.reload()
      })

      init()
    </script>
  </body>
</html>
